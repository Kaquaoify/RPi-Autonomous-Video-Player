<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RPi AVP • Assistant rclone</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <header class="appbar">
    <div class="brand">RPi AVP</div>
    <nav class="nav">
      <a class="navlink" href="/">Accueil</a>
      <a class="navlink" href="/settings">Paramètres</a>
      <a class="navlink active" href="/rclone-setup">Assistant rclone</a>
    </nav>
    <div class="flex-spacer"></div>
  </header>

  <div class="container">
    <section class="card">
      <h2><i class="fa-solid fa-plug"></i> État de rclone</h2>
      <div class="row">
        <span id="rcloneVersion" class="badge">—</span>
        <button id="btnRefreshVersion" class="btn btn-light">Rafraîchir</button>
      </div>
    </section>

    <section class="card">
      <h2><i class="fa-solid fa-cloud"></i> Remote & Dossier</h2>
      <div class="row">
        <label for="selectRemote">Remote par défaut</label>
        <select id="selectRemote"></select>
        <button id="btnReloadRemotes" class="btn btn-light">Recharger</button>
      </div>
      <div class="row">
        <label for="inputFolder">Dossier distant</label>
        <input id="inputFolder" type="text" placeholder="ex: VideosRPi" value="{{ remote_folder|e }}">
        <button id="btnSaveFolder" class="btn btn-primary">Enregistrer</button>
      </div>
      <p class="muted">Remote effectif : <code id="remoteSpecPreview"></code></p>
    </section>

    <section class="card">
      <h2><i class="fa-solid fa-arrows-rotate"></i> Synchronisation</h2>
      <div class="row">
        <button id="btnStartSync" class="btn btn-primary">Lancer une synchronisation</button>
        <span id="syncStatus" class="badge">inconnu</span>
      </div>
      <details class="section">
        <summary>Journal rclone</summary>
        <pre id="logBox" class="log-box">—</pre>
        <div class="row">
          <label for="logLines">Lignes</label>
          <input id="logLines" type="number" min="50" step="50" value="300" style="width:110px;">
          <button id="btnReloadLog" class="btn btn-light">Recharger le journal</button>
        </div>
      </details>
      <div class="row">
        <button id="btnRefreshVideos" class="btn btn-light"><i class="fa-solid fa-rotate"></i> Rescanner les vidéos</button>
      </div>
    </section>
  </div>

  <script>
  async function jget(u){const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(u+" -> "+r.status); return r.json();}
  async function jpost(u,b){const r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:b?JSON.stringify(b):"{}"}); if(!r.ok) throw new Error(u+" -> "+r.status); return r.json();}

  const elVersion=()=>document.getElementById("rcloneVersion");
  const elRemotes=()=>document.getElementById("selectRemote");
  const elFolder =()=>document.getElementById("inputFolder");
  const elSpec   =()=>document.getElementById("remoteSpecPreview");
  const elStatus =()=>document.getElementById("syncStatus");
  const elLog    =()=>document.getElementById("logBox");
  const elLines  =()=>document.getElementById("logLines");

  let defaultRemote="{{ default_remote|e }}";

  function updateSpec(){
    const r=(elRemotes().value||defaultRemote).trim();
    const f=(elFolder().value||"").trim().replace(/^\/+|\/+$/g,"");
    elSpec().textContent = f ? `${r}:${f}` : `${r}:`;
  }

  async function loadVersion(){
    try{ const d=await jget("/api/rclone/version");
      if(d.available==="yes") elVersion().textContent=d.version||"rclone présent";
      else if(d.available==="no") elVersion().textContent="rclone introuvable";
      else elVersion().textContent="Erreur";
    }catch(e){ elVersion().textContent="Erreur: "+e.message; }
  }
  async function loadRemotes(){
    try{ const d=await jget("/api/rclone/remotes");
      elRemotes().innerHTML=""; (d.items||[]).forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; elRemotes().appendChild(o); });
      defaultRemote=d.default||defaultRemote;
      if((d.items||[]).includes(defaultRemote)) elRemotes().value=defaultRemote;
      updateSpec();
    }catch(e){ elRemotes().innerHTML="<option>(erreur)</option>"; }
  }
  async function loadFolder(){
    try{ const d=await jget("/api/rclone/remote_folder"); if(d.ok) elFolder().value=d.remote_folder||"{{ remote_folder|e }}"; updateSpec(); }
    catch{ updateSpec(); }
  }
  async function saveFolder(){
    try{ const d=await jpost("/api/rclone/remote_folder", { remote_folder: elFolder().value.trim() });
      alert(d.ok?"Dossier mis à jour":"Erreur: "+(d.error||"inconnue"));
      updateSpec();
    }catch(e){ alert("Erreur réseau: "+e.message); }
  }

  let poll=null;
  async function startSync(){
    try{
      const rep=await jpost("/api/rclone/sync", { remote: elRemotes().value||defaultRemote, folder: elFolder().value.trim() });
      if(rep.started){ elStatus().textContent="en cours…"; elStatus().style.background="#393b14"; pollStatus(); }
      else { elStatus().textContent="déjà en cours"; elStatus().style.background="#393b14"; }
    }catch(e){ alert("Erreur: "+e.message); }
  }
  async function pollStatus(){
    clearInterval(poll);
    poll=setInterval(async()=>{
      try{
        const st=await jget("/api/rclone/sync_status");
        if(st.running){ elStatus().textContent="en cours…"; await reloadLog(false); }
        else { clearInterval(poll); elStatus().textContent="terminée"; elStatus().style.background="#143b14"; await reloadLog(true); }
      }catch(e){ clearInterval(poll); elStatus().textContent="erreur"; elStatus().style.background="#3b1414"; }
    }, 2000);
  }
  async function reloadLog(scrollBottom){
    try{
      const n=Math.max(50, parseInt(elLines().value||"300",10));
      const rep=await jget("/api/rclone/log?lines="+n);
      elLog().textContent=rep.log||"—";
      if(scrollBottom) elLog().scrollTop=elLog().scrollHeight;
    }catch{ elLog().textContent="(erreur de lecture du journal)"; }
  }
  async function refreshVideos(){
    try{ await jpost("/control/refresh"); alert("Liste rescannée."); }catch(e){ alert("Erreur: "+e.message); }
  }

  document.getElementById("btnRefreshVersion").addEventListener("click", loadVersion);
  document.getElementById("btnReloadRemotes").addEventListener("click", loadRemotes);
  document.getElementById("btnSaveFolder").addEventListener("click", saveFolder);
  document.getElementById("btnStartSync").addEventListener("click", startSync);
  document.getElementById("btnReloadLog").addEventListener("click", ()=>reloadLog(true));
  document.getElementById("btnRefreshVideos").addEventListener("click", refreshVideos);
  document.getElementById("selectRemote").addEventListener("change", updateSpec);
  document.getElementById("inputFolder").addEventListener("input", updateSpec);

  (async function init(){ await loadVersion(); await loadRemotes(); await loadFolder(); await reloadLog(false); })();
  </script>
</body>
</html>
