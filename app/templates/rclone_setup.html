{% extends "settings.html" %}
{% block content %}
<div class="container">
  <h1>Rclone – Configuration & Synchronisation</h1>

  <section class="card">
    <h2>État de rclone</h2>
    <div id="rcloneVersion" class="muted">Vérification en cours…</div>
    <button id="btnRefreshVersion" class="btn">Rafraîchir</button>
  </section>

  <section class="card">
    <h2>Remote & Dossier</h2>
    <div class="row">
      <label for="selectRemote">Remote par défaut</label>
      <select id="selectRemote"></select>
      <button id="btnReloadRemotes" class="btn btn-light">Recharger</button>
    </div>

    <div class="row">
      <label for="inputFolder">Dossier distant (dans le remote)</label>
      <input id="inputFolder" type="text" placeholder="ex: VideosRPi" value="{{ remote_folder|e }}">
      <button id="btnSaveFolder" class="btn">Enregistrer</button>
    </div>

    <p class="muted" id="folderHint">Remote effectif pour la sync : <code id="remoteSpecPreview"></code></p>
  </section>

  <section class="card">
    <h2>Synchronisation</h2>
    <div class="row">
      <button id="btnStartSync" class="btn btn-primary">Lancer une synchronisation</button>
      <span id="syncStatus" class="badge">inconnu</span>
    </div>
    <details class="mt">
      <summary>Journal rclone</summary>
      <pre id="logBox" class="log-box">—</pre>
      <div class="row">
        <label for="logLines">Lignes</label>
        <input id="logLines" type="number" min="50" step="50" value="300" style="width:110px;">
        <button id="btnReloadLog" class="btn btn-light">Recharger le journal</button>
      </div>
    </details>
  </section>

  <section class="card">
    <h2>Post-sync (optionnel)</h2>
    <p>Après la synchronisation, vous pouvez rescanner et rafraîchir l’interface.</p>
    <div class="row">
      <button id="btnRefreshVideos" class="btn btn-light">Rescanner les vidéos</button>
    </div>
  </section>
</div>

<style>
  .container { max-width: 880px; margin: 0 auto; }
  .card { background: #111; border: 1px solid #222; border-radius: 12px; padding: 16px; margin: 16px 0; }
  .row { display: flex; gap: 12px; align-items: center; margin: 8px 0; flex-wrap: wrap; }
  .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #333; background:#1b1b1b; cursor:pointer; }
  .btn:hover { background:#232323; }
  .btn-primary { background:#2a5bd7; border-color:#2a5bd7; }
  .btn-primary:hover { background:#204db6; }
  .btn-light { background:#1f1f1f; }
  .badge { padding: 4px 8px; border-radius: 999px; background:#222; border:1px solid #333; font-size: 0.9rem; }
  .muted { color:#a0a0a0; }
  .mt { margin-top: 10px; }
  .log-box { max-height: 320px; overflow:auto; background:#0b0b0b; border:1px solid #222; padding:12px; }
  label { min-width: 200px; }
  input[type="text"] { padding: 8px; border-radius: 8px; border:1px solid #333; background:#0f0f0f; color:#fff; min-width: 300px; }
  select { padding: 8px; border-radius: 8px; border:1px solid #333; background:#0f0f0f; color:#fff; }
  code { background:#0d0d0d; padding:2px 6px; border-radius:6px; border:1px solid #222; }
</style>

<script>
  // --- Helpers API fetch ---
  async function jget(url) {
    const r = await fetch(url, {cache: "no-store"});
    if (!r.ok) throw new Error("GET " + url + " -> " + r.status);
    return r.json();
  }
  async function jpost(url, body) {
    const r = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: body ? JSON.stringify(body) : "{}"
    });
    if (!r.ok) throw new Error("POST " + url + " -> " + r.status);
    return r.json();
  }

  // --- UI elements ---
  const elVersion  = () => document.getElementById("rcloneVersion");
  const elRemotes  = () => document.getElementById("selectRemote");
  const elFolder   = () => document.getElementById("inputFolder");
  const elSpecPrev = () => document.getElementById("remoteSpecPreview");
  const elStatus   = () => document.getElementById("syncStatus");
  const elLogBox   = () => document.getElementById("logBox");
  const elLogLines = () => document.getElementById("logLines");

  // --- State ---
  let defaultRemote = "{{ default_remote|e }}";

  function updateRemoteSpecPreview() {
    const r = (elRemotes().value || defaultRemote).trim();
    const f = (elFolder().value || "").trim().replace(/^\/+|\/+$/g, "");
    const spec = f ? `${r}:${f}` : `${r}:`;
    elSpecPrev().textContent = spec;
  }

  // --- Loaders ---
  async function loadVersion() {
    try {
      const data = await jget("/api/rclone/version");
      if (data.available === "yes") {
        elVersion().textContent = data.version || "rclone présent";
      } else if (data.available === "no") {
        elVersion().textContent = "rclone introuvable (installez rclone)";
      } else {
        elVersion().textContent = "Erreur: " + (data.version || "inconnue");
      }
    } catch (e) {
      elVersion().textContent = "Erreur: " + e.message;
    }
  }

  async function loadRemotes() {
    try {
      const data = await jget("/api/rclone/remotes");
      const items = data.items || [];
      elRemotes().innerHTML = "";
      for (const name of items) {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        elRemotes().appendChild(opt);
      }
      const def = data.default || defaultRemote;
      defaultRemote = def;
      if (items.includes(def)) {
        elRemotes().value = def;
      } else if (items.length) {
        elRemotes().value = items[0];
      }
      updateRemoteSpecPreview();
    } catch (e) {
      elRemotes().innerHTML = "<option>(erreur)</option>";
    }
  }

  async function loadRemoteFolder() {
    try {
      const data = await jget("/api/rclone/remote_folder");
      if (data.ok) elFolder().value = data.remote_folder || "{{ remote_folder|e }}";
      updateRemoteSpecPreview();
    } catch (e) {
      // garde la valeur du template si erreur
      updateRemoteSpecPreview();
    }
  }

  // --- Actions ---
  async function saveFolder() {
    const folder = elFolder().value.trim();
    try {
      const data = await jpost("/api/rclone/remote_folder", { remote_folder: folder });
      if (data.ok) {
        toast("Dossier mis à jour");
        updateRemoteSpecPreview();
      } else {
        toast("Erreur: " + (data.error || "inconnue"), true);
      }
    } catch (e) {
      toast("Erreur réseau: " + e.message, true);
    }
  }

  let pollTimer = null;

  async function startSync() {
    // Lance la sync avec les valeurs UI
    const remote = elRemotes().value || defaultRemote;
    const folder = elFolder().value.trim();
    try {
      const rep = await jpost("/api/rclone/sync", { remote, folder });
      if (rep.started) {
        elStatus().textContent = "en cours…";
        elStatus().style.background = "#3b3b14";
        pollSync();
      } else {
        elStatus().textContent = "déjà en cours";
        elStatus().style.background = "#3b3b14";
        toast("Une synchronisation est déjà en cours.");
      }
    } catch (e) {
      toast("Erreur: " + e.message, true);
    }
  }

  async function pollSync() {
    clearInterval(pollTimer);
    pollTimer = setInterval(async () => {
      try {
        const st = await jget("/api/rclone/sync_status");
        if (st.running) {
          elStatus().textContent = "en cours…";
          elStatus().style.background = "#3b3b14";
          await reloadLog(false);
        } else {
          clearInterval(pollTimer);
          elStatus().textContent = "terminée";
          elStatus().style.background = "#143b14";
          await reloadLog(true);
          toast("Synchronisation terminée. Pensez à rescanner les vidéos.");
        }
      } catch (e) {
        clearInterval(pollTimer);
        elStatus().textContent = "erreur";
        elStatus().style.background = "#3b1414";
        toast("Erreur de statut sync: " + e.message, true);
      }
    }, 2000);
  }

  async function reloadLog(scrollBottom = false) {
    try {
      const n = Math.max(50, parseInt(elLogLines().value || "300", 10));
      const rep = await jget("/api/rclone/log?lines=" + n);
      elLogBox().textContent = rep.log || "—";
      if (scrollBottom) elLogBox().scrollTop = elLogBox().scrollHeight;
    } catch (e) {
      elLogBox().textContent = "(erreur de lecture du journal)";
    }
  }

  async function refreshVideos() {
    try {
      await jpost("/control/refresh");
      toast("Liste des vidéos rescannée.");
    } catch (e) {
      toast("Erreur refresh: " + e.message, true);
    }
  }

  // --- Tiny toast ---
  function toast(msg, isErr=false) {
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.position = "fixed";
    el.style.right = "16px";
    el.style.bottom = "16px";
    el.style.padding = "10px 14px";
    el.style.borderRadius = "10px";
    el.style.background = isErr ? "#501c1c" : "#1c2b50";
    el.style.border = "1px solid #333";
    el.style.zIndex = 9999;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

  // --- Wiring ---
  document.getElementById("btnRefreshVersion").addEventListener("click", loadVersion);
  document.getElementById("btnReloadRemotes").addEventListener("click", loadRemotes);
  document.getElementById("btnSaveFolder").addEventListener("click", saveFolder);
  document.getElementById("btnStartSync").addEventListener("click", startSync);
  document.getElementById("btnReloadLog").addEventListener("click", () => reloadLog(true));
  document.getElementById("btnRefreshVideos").addEventListener("click", refreshVideos);
  document.getElementById("selectRemote").addEventListener("change", updateRemoteSpecPreview);
  document.getElementById("inputFolder").addEventListener("input", updateRemoteSpecPreview);

  // --- Boot ---
  (async function init() {
    await loadVersion();
    await loadRemotes();
    await loadRemoteFolder();
    await reloadLog(false);
  })();
</script>
{% endblock %}
